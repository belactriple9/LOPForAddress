<!DOCTYPE html>
<html>

<head>
    <script type="text/json"
        src="https://cdn.jsdelivr.net/npm/@1inch/limit-order-protocol@1.3.0/abi/LimitOrderProtocol.json"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.3.6/dist/web3.min.js" type="text/javascript"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <script async>

        localStorage.setItem("page", 1);

        let chainId = 1; //it's 1 by default
        let tokenlist;
        let provider;
        let signer;
        let abi = "";

        let ethplorerKey = "freekey";


        $(() => {


            $('#next').on('click', (e) => {
                e.preventDefault();
                localStorage.setItem("page", Number.parseInt(localStorage.getItem("page")) + 1);
                $('#page-number').text(localStorage.getItem("page"));
            })
            $('#previous').on('click', (e) => {
                e.preventDefault();

                if (localStorage.getItem("page") > 1)
                    localStorage.setItem("page", Number.parseInt(localStorage.getItem("page")) - 1);
                $('#page-number').text(localStorage.getItem("page"));
            })

            $('#search-btn').on('click', (e) => {
                e.preventDefault(); //*CRITICAL* : this "catches" the form submit event and stops it

                async function driver() {
                    let address = document.getElementById("address").value;

                    chainId = document.getElementById("drop-down").value;

                    $('#results').text(""); //delete results
                    try {
                        await $.ajax({ method: "GET", url: "https://apiv4.paraswap.io/v2/tokens/" + chainId }).done((ret) => {
                            tokenlist = ret.tokens;
                        })
                    }
                    catch (e) {
                        //tokenlist fallback
                        try {
                            await $.ajax({ method: "GET", url: "https://tokens.1inch.exchange/v1.1/" + chainId }).done((ret) =>
                                tokenlist = ret)
                        } catch (e) {
                            alert("an error has occured, orders may not load");
                        }
                    }

                    if (address != "")
                        getAddressLOList(address, chainId)


                }


                function getAddressLOList(address, chain) {
                    let url = "https://limit-orders.1inch.exchange/v1.0/" + chain + "/limit-order/address/" + address + "?page=" + localStorage.getItem("page") + "&limit=100&statuses=%5B1%2C2%5D"
                    $.ajax({ method: "GET", dataType: "json", url: url }).done((ret) => {
                        console.log(ret);
                        parseAddressLOResults(ret, address, chain);
                    })
                }

                async function parseAddressLOResults(orders, address, chain) {
                    let fromToken;
                    let toToken;
                    let url = 'https://api.1inch.exchange/v3.0/' + chain + '/quote?' //'fromTokenAddress=' + fromToken + '&toTokenAddress=' + toToken + '&amount=1000000000000000000'
                    let tokenInfo;

                    let scan = getBlockchainScannerForToken(chain);

                    for (let i = 0; i < orders.length; i++) {


                        //if (fromToken != orders[i].data.makerAsset && toToken != orders[i].data.takerAsset) {
                        if (fromToken != orders[i].data.makerAsset)
                            fromToken = orders[i].data.makerAsset;
                        if (toToken != orders[i].data.takerAsset)
                            toToken = orders[i].data.takerAsset;
                        try {
                            if (tokenlist[tokenlist.findIndex(item => item.address === orders[i].data.makerAsset)].decimals < 18) //if the maker token has less than 18 dcimals
                                orders[i].remainingMakerAmount = (orders[i].remainingMakerAmount * Math.pow(10, 18 - orders[i].fromTokenInfo.decimals)); //pad until 18 decimals
                        } catch (e) {
                            console.log("Can't pad, assuming makerAmount has 18 decimals");
                        }

                        if ( //if offerRecieve fails, try the next
                            await offerRecieve(url, toToken, fromToken, orders[i].remainingMakerAmount, orders[i], scan)
                        ) {
                            if (
                                await offerRecieveFlipped(url, toToken, fromToken, orders[i].remainingMakerAmount, orders[i], scan)
                            ) {
                                $('#results').append("Unable to find token info for " + toToken + " to " + fromToken + '<hr>');
                            }
                        }
                        // } else {
                        //     let displayInfo = "";
                        //     displayInfo += "Your Offer: " + (orders[i].makerAmount / Math.pow(10, tokenInfo.fromToken.decimals))
                        //         + " <a href=\"" + scan + fromToken + "\">" + tokenInfo.fromToken.symbol + "</a>" + "\n";
                        //     displayInfo += "You Recieve: " + (orders[i].takerAmount / Math.pow(10, tokenInfo.toToken.decimals))
                        //         + " <a href=\"" + scan + toToken + "\">" + tokenInfo.toToken.symbol + "</a>";

                        //     //displayInfo += "<button onClick=\"cancelOrder(this.value)\" value=" + JSON.stringify(orders[i].data) + ">Cancel order?</button>\n";

                        //     displayInfo += "Left to Fill: " + orders[i].remainingMakerAmount / Math.pow(10, tokenInfo.fromToken.decimals) + " " + tokenInfo.fromToken.symbol + "\n";

                        //     $('#results').append(displayInfo + '<hr>');
                        // }
                    }
                }

                                async function offerRecieve(url, toToken, fromToken, amount, orderData, chainURL) {
                    let displayInfo = "";
                    try {
                        await $.ajax({ method: "GET", dataType: "json", url: url + 'fromTokenAddress=' + toToken + '&toTokenAddress=' + fromToken + '&amount=' + amount }).done((ret) => {
                            console.log(ret);
                            tokenInfo = ret;

                            displayInfo += "Your Offer: " + (orderData.takerAmount / Math.pow(10, tokenInfo.fromToken.decimals))
                                + " <a href=\"" + chainURL + toToken + "\">" + tokenInfo.fromToken.symbol + "</a>" + "\n";
                            displayInfo += "You Recieve: " + (orderData.makerAmount / Math.pow(10, tokenInfo.toToken.decimals))
                                + " <a href=\"" + chainURL + fromToken + "\">" + tokenInfo.toToken.symbol + "</a>" + "\n";

                            displayInfo += "Left to Fill: " + amount / Math.pow(10, tokenInfo.toToken.decimals) + " " + tokenInfo.toToken.symbol + "\n";
                            //displayInfo += "<button onClick=\"cancelOrder(this.value)\" value=" + JSON.stringify(orderData.data) + ">Cancel order?</button>\n";

                            $('#results').append(displayInfo + '<hr>');
                        })
                    }
                    catch (e) {
                        return true; //return true upon failure
                    }
                    return false; //return false if it works
                }

                async function offerRecieveFlipped(url, toToken, fromToken, amount, orderData, chainURL) {
                    let displayInfo = "";
                    console.log("Flipping quote");
                    try {
                        await $.ajax({ method: "GET", dataType: "json", url: url + 'fromTokenAddress=' + fromToken + '&toTokenAddress=' + toToken + '&amount=' + amount }).done((ret) => {
                            console.log(ret);
                            tokenInfo = ret;

                            displayInfo += "Your Offer: " + (orderData.makerAmount / Math.pow(10, tokenInfo.fromToken.decimals))
                                + " <a href=\"" + chainURL + toToken + "\">" + tokenInfo.fromToken.symbol + "</a>" + "\n";
                            displayInfo += "You Recieve: " + (orderData.takerAmount / Math.pow(10, tokenInfo.toToken.decimals))
                                + " <a href=\"" + chainURL + fromToken + "\">" + tokenInfo.toToken.symbol + "</a>" + "\n";


                            displayInfo += "Left to Fill: " + amount / Math.pow(10, tokenInfo.toToken.decimals) + " " + tokenInfo.toToken.symbol + "\n";
                            //displayInfo += "<button onClick=\"cancelOrder(this.value)\" value=" + JSON.stringify(orderData.data) + ">Cancel order?</button>\n";

                            $('#results').append(displayInfo + '<hr>');
                        })
                    } catch (e) {
                        return true; //return true upon failure
                    }
                    return false; //return false if it works
                }

                function getBlockchainScannerForToken(chain) {
                    switch (chain) {
                        case "1": return "https://etherscan.io/token/"
                            break;
                        case "56": return "https://bscscan.com/token/"
                            break;
                        case "137": return "https://polygonscan.com/token/"
                            break;
                    }
                }

                driver();
            })
        })//end search-btn



    </script>



</head>

<body>

    <h1>1inch Limit orders on account</h1>

    <pre>
----------------------------------------------------------- 

1) Input an address
2) Press search button
3) orders associated with that address will be displayed

----------------------------------------------------------- 
</pre>

    <text>First, select a chain</text>

    <form>
        <select id="drop-down">
            <option value="1">1 ETH</option>
            <option value="56">56 BSC</option>
            <option value="137">137 MATIC</option>
        </select>
    </form>
    <br>

    <text>Then</text>

    <br><br>

    <form style="height:30px">
        <text>Enter an Address </text>
        <input type="text" id="address" style="width:250px;"></input>
    </form>

    <br>
    <form>
        <button id="search-btn" style="height:30px">Search</button>
        <button id="previous" style="height:30px;width:200px">Previous Page</button>
        <text id="page-number">1</text>
        <button id="next" style="height:30px;width:200px">Next Page</button>
    </form>


    <br>



    <h4>Results</h4>
    <p id="results" style="white-space: pre-line; display: block;">

    </p>

</body>



<style>

</style>

</html>
